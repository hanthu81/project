_format_version: "3.0"
_transform: true

certificates:
  - id: 018f8c09-ad54-4708-838b-336261ab8c33
    cert: |
      -----BEGIN CERTIFICATE-----
      MIICrDCCAZQCFHyeUI/SHe/E4gi5/3dFZqdG+6seMA0GCSqGSIb3DQEBCwUAMBYx
      FDASBgNVBAMMC1plcm9UcnVzdENBMB4XDTI1MTAzMDE0NDIxNFoXDTI2MTAzMDE0
      NDIxNFowDzENMAsGA1UEAwwEa29uZzCCASIwDQYJKoZIhvcNAQEBBQADggEPADCC
      AQoCggEBAMo2zw7RKTsaAHfiyOBMYI5QwulEFRKuNfnPKH2Yvh0Hz4pJHsUW9uPd
      6CFZOLNA2TSxAvvTRSzMsmu939rUKESTIDykaL5PrO/WA5JGRAPnqaVa6xDmYjiy
      eH1jauzunZcfp29BraFpsRppoCKx6H5tDwEpss0aKcyWLCrVgEXBekHKRf67Oq4j
      Eu3pIDuKiftyK9MLQ/ilrCLmlAJjMSphl5mfAdm/S4TZzDqyBejmyJ6Q0f3x5Xi0
      kmAmpON3cL2ieo39/+XO6D75dK7tyqo26JKZSpPEgtX+AEfX7BIADGPW8/UbLGKQ
      0d1UyCVAkmKbz+EsANItZBHbPnn8CmkCAwEAATANBgkqhkiG9w0BAQsFAAOCAQEA
      g0geJlsGW6qpNy9/GJ6z475FGcN2AZmehhs7pR3i4SlKLpIKxxy5F8fvVxefYKCz
      MdQYA5aDiuwJEnUqHmPjaBxHUnLnDijXF9fzyRNanhtOro21aNVEWFVvW5J7jpJ2
      KW+Fv5lPZ9pMhZRGrk+0cwiyQyPlCZdW1KtskIPW/vk15PUcKdxVUbJhUWNFIn5i
      sVvjSlC3urpYtGIuLt6Q+/Q48aZKaefVb5zBALfWEG6srlVin/msePmbj48gLIma
      srNUeRdak8itbNHQy39eiC1nV59FdMdt92P0cggfp9Pp83V5OP2XqYFXYTWGnQDH
      ZDyCTmYQd58npV3+cot3rw==
      -----END CERTIFICATE-----
    key: |
      -----BEGIN PRIVATE KEY-----
      MIIEvgIBADANBgkqhkiG9w0BAQEFAASCBKgwggSkAgEAAoIBAQDKNs8O0Sk7GgB3
      4sjgTGCOUMLpRBUSrjX5zyh9mL4dB8+KSR7FFvbj3eghWTizQNk0sQL700UszLJr
      vd/a1ChEkyA8pGi+T6zv1gOSRkQD56mlWusQ5mI4snh9Y2rs7p2XH6dvQa2habEa
      aaAiseh+bQ8BKbLNGinMliwq1YBFwXpBykX+uzquIxLt6SA7ion7civTC0P4pawi
      5pQCYzEqYZeZnwHZv0uE2cw6sgXo5siekNH98eV4tJJgJqTjd3C9onqN/f/lzug+
      +XSu7cqqNuiSmUqTxILV/gBH1+wSAAxj1vP1GyxikNHdVMglQJJim8/hLADSLWQR
      2z55/AppAgMBAAECggEADw1D3dw7V7MgiEv4/FsrD8TasU7YS7bsfR8KqkiplBMe
      A3LcZ7rFH2KH8h2ITy17TYUEjhakjkhhWow8YrdKlQoniuQJCOt42bRiOSviSbEf
      i1eoai5f7sz4E4tILQE4+UQJrEolAMAThv4IRbTc87Yt+P3v2X0CUgB2oqyYOvjh
      PwBT4C64HhVuy0C8SQYay5r+INjlohoqcptoCi8raPOSiGg3NvTVbc2gGdJAOSeN
      D9EEs9Jl96KekMluqD3QjPFzYUBWaUGk48QpXC3LZU27LB9CtAi0SXvPYvSLScAx
      NW6nCT7dAO+9JMo6jAWtvh0qXkkMACGbdRLwQGhNRQKBgQDgXjTctoX5VqG7PZ+B
      CF/stydXg/V67+hiSZ0Pr+hpg/lx/BhdAmMHM+g8aUBWuTixBSUJnq5QtdheUmZ8
      f50OWxbdI7TsxzDCCVFeEtXDw/+mPmLnmVfMAtAQfJeH62E3O6lrf18TLkuYqyKj
      MfMbchGnWYX14iUzpvadSLCL7QKBgQDmuQiKfKQ66RbYXh5uPNCmi1hlTOtHfh3b
      slR9e3DROIufbjr6RCGdo69nx8ULA6m5pQpouf4tVrZAVqR3LSjWIzRd3fYf/B+y
      PQA0gRX9USH+ZBcr5oBFg/Ioe3nKCML3PBm5bVSZXZV/R1nkSNe+MGxTWrgKbgMy
      92G4QGSA7QKBgQDdQKkaWbeF6MM2NI99G7gUY4ydRZimsbvUaMlENfCXVLiAiduw
      pHDpImvKXvQ+UQqxreQXN26oUppacSF1dhZ3mKXUTqjUsZzIS438mdBI65fH5U99
      GX81xDRPfb2kIB5O7DumsQUdkhKkK2bNzazxjKwR/jsW/Po4lFYvRgYrBQKBgBZE
      Y1uiPeNlnYvSQZOYEPcR2b0lGEv1EwKiCl9162R11ZvUcqK2spvZMVONxymR9+5v
      zDphQPO1O6+n7QWHeTp5eVNZ2agqmBCGrJ9kme+xxdscY9Qb0eNjoZpgmFd0UwSz
      azQnJhQLISOAil9q3E+BsuK0jbCL/4kKsQasSEbdAoGBALlSIefqjYfjMOKB2xQl
      tNhGaNHYMtUolCjjFVfL2QzfDI5OtPRjIJh7O8F7KT1FqgCZichuaFSW2gdu9JVc
      KWcCoTWneMym7AjmYMm84nqLBINCTzWL05Xk6D8//ozkPuC2UTh/2QiGE2rPVQhG
      cahHUYa7KdaKayQMGrffIUrO
      -----END PRIVATE KEY-----

services:
  - name: user-api
    url: https://192.168.174.130:3000/user/profile
    client_certificate:
      id: 018f8c09-ad54-4708-838b-336261ab8c33
    routes:
      - name: api-user
        paths:
          - /user/api
        protocols:
          - https
  - name: admin-api
    url: https://192.168.174.130:3000/admin/stats
    client_certificate:
      id: 018f8c09-ad54-4708-838b-336261ab8c33
    routes:
      - name: api-admin
        paths:
          - /admin/api
        protocols:
          - https

plugins:
  - name: jwt
    service: user-api
    config:
      claims_to_verify:
        - exp
      key_claim_name: iss
      run_on_preflight: true
      secret_is_base64: false
  - name: jwt
    service: admin-api
    config:
      claims_to_verify:
        - exp
      key_claim_name: iss
      run_on_preflight: true
      secret_is_base64: false


  - name: rate-limiting
    service: admin-api
    config:
      minute: 60      # 60 requests per minute
      hour: 1000      # 1000 requests per hour
      day: 10000      # 10000 requests per day
      policy: local
      limit_by: consumer  # Giới hạn theo consumer
  - name: rate-limiting
    service: user-api
    config:
      minute: 60      # 60 requests per minute
      hour: 1000      # 1000 requests per hour
      day: 10000      # 10000 requests per day
      policy: local
      limit_by: consumer  # Giới hạn theo consumer


  - name: opa-abac
    service: user-api
  - name: opa-abac
    service: admin-api
    
   
  - name: file-log
    service: user-api
    config:
      path: /usr/local/kong/logs/file-log.log
      reopen: true
  - name: file-log
    service: admin-api
    config:
      path: /usr/local/kong/logs/file-log.log
      reopen: true


  - name: ip-blocker
    service: user-api
    config:
      redis_host: 192.168.174.128
      redis_port: 6379
      redis_set: blocked_ips
  - name: ip-blocker
    service: admin-api
    config:
      redis_host: 192.168.174.128
      redis_port: 6379
      redis_set: blocked_ips

consumers:
  - username: test
    custom_id: service
    jwt_secrets:
    - algorithm: "RS256"
      key: "http://localhost:8080/realms/api-gateway"
      rsa_public_key: |
        -----BEGIN PUBLIC KEY-----
        MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA8Ns46rjBSuSPxj/ZBCA/4Of2y0QJS0VfxumdHukrnuwaXv6e7N0qcP2F0EhyhcLV8Dzz1BFYeOc7t6VgHnqfKhhgfbbPtSpQ1BQyjyefrI8eLFv1fkmsYsv1wxQoNPfgMiwiCQCD9t1BQpkQBzbzXpiIXg6eSXL07iOf0+XPe2IF7YGFEAWKZaamOcOCXxWkYfeyEDzBJ983tJClLsQMvqaAvWgBnnZByHrzkjc1VI5u2cVP5dpq3Yhgw7U7E8rmTMknnRaRnzE5PbijN/o0kD8S8PQG/jj9tcRV6YReYmRbAZyZC5oxh0Y4Ex/7/YHhVmb0aV8wtfhSr5cyjXWjEQIDAQAB
        -----END PUBLIC KEY-----
